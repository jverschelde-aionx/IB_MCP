services:
  api_gateway:
    container_name: api_gateway
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    image: ib_mcp_api_gateway:v0.1
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    env_file:
      - .env
    environment:
      - XX:XX
      - GATEWAY_INTERNAL_BASE_URL: ${GATEWAY_INTERNAL_BASE_URL}
      - GATEWAY_PORT: ${GATEWAY_PORT:-5055}
      - GATEWAY_ENDPOINT: ${GATEWAY_ENDPOINT:-/v1/api}
      - GATEWAY_TEST_ENDPOINT: ${GATEWAY_TEST_ENDPOINT:-/v1/api/iserver/account/orders}
      - TICKLE_INTERVAL: ${TICKLE_INTERVAL:-60}
      - TICKLE_BASE_URL: ${TICKLE_BASE_URL:-https://host.docker.internal:5055/v1/api}
      - TICKLE_ENDPOINT: ${TICKLE_ENDPOINT:-/tickle}
      - MCP_SERVER_BASE_URL: ${MCP_SERVER_BASE_URL:-https://localhost}
      - GATEWAY_INTERNAL_BASE_URL: ${GATEWAY_INTERNAL_BASE_URL:-https://host.docker.internal}
    networks:
      - mcp_net
    volumes:
      - ./api_gateway/conf.yaml:/app/api_gateway/root/conf.yaml # Mount the config file
    healthcheck:
      # Dedicated healthcheck script for cleaner logic and better environment variable handling.
      # The script is copied into the container image via the Dockerfile.
      test: [ "CMD-SHELL", "/usr/local/bin/healthcheck.sh" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
  
  mcp_server:
    container_name: mcp_server
    build:
      context: ./mcp_server
      dockerfile: Dockerfile
    image: ib_mcp_mcp_server:v0.0
    ports:
      - "${MCP_SERVER_PORT}:${MCP_SERVER_PORT}"
    env_file:
      - .env
    environment:
      - ROUTERS_PATH: /app/mcp_server/routers
      - GATEWAY_BASE_URL: ${GATEWAY_INTERNAL_BASE_URL:-https://host.docker.internal}
      - GATEWAY_PORT: ${GATEWAY_PORT:-5055}
      - GATEWAY_ENDPOINT: ${GATEWAY_ENDPOINT:-/v1/api}
      - MCP_SERVER_HOST: ${MCP_SERVER_HOST:-0.0.0.0}
      - MCP_SERVER_PORT: ${MCP_SERVER_PORT:-5002}
      - MCP_TRANSPORT_PROTOCOL: ${MCP_TRANSPORT_PROTOCOL:-streamable-http}
      - MCP_SERVER_BASE_URL: ${MCP_SERVER_INTERNAL_BASE_URL:-https://host.docker.internal}
      - MCP_SERVER_INTERNAL_BASE_URL: ${MCP_SERVER_INTERNAL_BASE_URL:-https://host.docker.internal}
      - MCP_SERVER_LOG_LEVEL: ${MCP_SERVER_LOG_LEVEL:-info}
      - MCP_SERVER_PATH: ${MCP_SERVER_PATH:-/mcp}
      - MCP_DEV_MODE: ${MCP_DEV_MODE:-true}
      - INCLUDED_TAGS: ${INCLUDED_TAGS:-Alerts,Contract,Events Contracts,FA Allocation Management,FYIs & Notifications,Market Data,Options Chains,Order Monitoring,Orders,Portfolio,Portfolio Analyst,Scanner,Session,Watchlists,Authorization Token,Account Management Reports}
      - EXCLUDED_TAGS: ${EXCLUDED_TAGS:-Options Chains, Orders, FA Allocation Management}
      - OPEN_API_SPEC_URL: ${OPEN_API_SPEC_URL:-https://api.ibkr.com/gw/api/v3/api-docs}
      - OPENAPI_FILE_PATH: ${OPENAPI_FILE_PATH:-openapi.json}
      - TICKLE_INTERVAL: ${TICKLE_INTERVAL:-60}
      - TICKLE_BASE_URL: ${TICKLE_BASE_URL:-https://host.docker.internal:5055/v1/api}
      - TICKLE_ENDPOINT: ${TICKLE_ENDPOINT:-/tickle}
      
    depends_on:
      api_gateway:
        condition: service_healthy
    networks:
      - mcp_net
    volumes:
      # Mount local directory for development
      - ./mcp_server:/app/mcp_server
    stdin_open: true
    tty: true
    restart: unless-stopped

networks:
  mcp_net:
    driver: bridge

